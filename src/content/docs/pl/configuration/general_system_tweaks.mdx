---
title: Ogólne poprawki systemowe
description: Rzeczy, które możesz zrobić, aby dostosować system po instalacji
---

import { Steps } from '@astrojs/starlight/components';

## AMD Ryzen

### Sterownik AMD P-State
---------------------------

`amd-pstate` to sterownik skalowania wydajności procesorów AMD, który wprowadza nowy mechanizm kontroli częstotliwości CPU dla nowoczesnych serii APU i CPU AMD w jądrze Linux. Nowy mechanizm opiera się na Collaborative Processor Performance Control (CPPC), który zapewnia bardziej precyzyjne zarządzanie częstotliwością niż starsze sprzętowe stany P ACPI. Obecne platformy CPU/APU AMD używają sterownika stanów P ACPI do zarządzania częstotliwością i taktowaniem CPU, przełączając się tylko między 3 stanami P. CPPC zastępuje kontrolki stanów P ACPI i pozwala na elastyczny interfejs o niskim opóźnieniu, za pomocą którego jądro Linux może bezpośrednio komunikować wskazówki dotyczące wydajności do sprzętu.

Poniżej znajdują się 3 tryby działania sterownika `amd-pstate` oraz wpisy linii poleceń jądra, aby używać ich podczas rozruchu:

- **AMD P-State (Tryb nieautonomiczny)**: `amd-pstate=passive`
- **AMD P-State Guided (Tryb wspomagany autonomicznie)**: `amd-pstate=guided`
- **AMD P-State EPP (Tryb autonomiczny)**: `amd-pstate=active`

:::note
Sterownik AMD P-State EPP jest używany domyślnie, jeśli nie dokonano zmian w konfiguracji.
:::

Możesz również przełączać się między trybami działania w czasie rzeczywistym, aby przetestować opcje:

- **Tryb autonomiczny**: platforma bierze pod uwagę tylko wartości ustawione dla minimalnej wydajności, maksymalnej wydajności i preferencji energetyczno-wydajnościowych.
   ```sh
   echo active | sudo tee /sys/devices/system/cpu/amd_pstate/status
   ```

- **Tryb wspomagany autonomicznie**: platforma ustawia poziom wydajności operacyjnej zgodnie z bieżącym obciążeniem i w granicach ustawionych przez system operacyjny za pomocą rejestrów minimalnej i maksymalnej wydajności.
   ```sh
   echo guided | sudo tee /sys/devices/system/cpu/amd_pstate/status
   ```

- **Tryb nieautonomiczny**: platforma pobiera żądany poziom wydajności bezpośrednio z systemu operacyjnego za pomocą rejestru żądanej wydajności.
   ```sh
   echo passive | sudo tee /sys/devices/system/cpu/amd_pstate/status
   ```

Więcej informacji:

*   [https://www.kernel.org/doc/html/v6.9/admin-guide/pm/amd-pstate.html](https://www.kernel.org/doc/html/v6.9/admin-guide/pm/amd-pstate.html)
*   [https://lore.kernel.org/lkml/20221110175847.3098728-1-Perry.Yuan@amd.com/](https://lore.kernel.org/lkml/20221110175847.3098728-1-Perry.Yuan@amd.com/)
*   [https://lore.kernel.org/lkml/20230119115017.10188-1-wyes.karny@amd.com/](https://lore.kernel.org/lkml/20230119115017.10188-1-wyes.karny@amd.com/)

### Konfiguracja AMD P-State EPP


Aby używać P-State EPP, dostępne są dwa regulatory skalowania częstotliwości procesora: **powersave** i **performance**. Zaleca się używanie regulatora `powersave` i ustawienie preferencji.

*   Ustaw regulator `powersave`: `sudo cpupower frequency-set -g powersave`
*   Ustaw regulator `performance`: `sudo cpupower frequency-set -g performance`

Aby ustawić wybraną preferencję, uruchom następujące polecenie z żądaną preferencją:

```sh
echo power | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference
```

Dostępne preferencje: `performance`, `power`, `balance_power`, `balance_performance`

Benchmarki dla każdej preferencji można znaleźć tutaj:
[https://lore.kernel.org/lkml/20221219064042.661122-1-perry.yuan@amd.com/](https://lore.kernel.org/lkml/20221219064042.661122-1-perry.yuan@amd.com/)

### Optymalizator AMD 3D V-Cache

AMD opublikowało łatkę optymalizującą harmonogramowanie pamięci podręcznej na procesorach 3D z podwójnym CCD, takich jak 7950X3D i 7900X3D.
Musisz ustawić w BIOS-ie opcję CPPC na "Driver". Pozwoli to na nadpisanie używanego trybu za pomocą sysfs.

Dostępne są dwa tryby:
1. Frequency (Częstotliwość)
2. Cache (Pamięć podręczna)

Jeśli ustawiony jest tryb `cache`, sterownik spróbuje umieścić zadania najpierw na CCD z większą pamięcią podręczną, co jest głównie korzystne w grach.
Opcja `frequency` spróbuje umieścić zadania na drugim CCD, który ma wyższą częstotliwość niż CCD z pamięcią podręczną 3D.

Frequency (Domyślny):
```sh
echo frequency | sudo tee /sys/bus/platform/drivers/amd_x3d_vcache/AMDI0101:00/amd_x3d_mode
```

Cache:
```sh
echo cache | sudo tee /sys/bus/platform/drivers/amd_x3d_vcache/AMDI0101:00/amd_x3d_mode
```

Po zmianie trybów, statystyki preferowanych rdzeni AMD powinny pokazywać inny ranking. Możesz go odczytać za pomocą:
```sh
grep -v /sys/devices/system/cpu/cpu*/cpufreq/amd_pstate_prefcore_ranking
```

### AMD P-State Core Performance Boost

AMD Core Performance Boost, znane również jako AMD Turbo Core, to technologia dynamicznego skalowania częstotliwości firmy AMD, która pozwala
procesorowi dynamicznie dostosowywać i kontrolować częstotliwość pracy w niektórych wersjach procesorów,
co pozwala na zwiększoną wydajność w razie potrzeby, przy jednoczesnym zachowaniu niższych parametrów mocy i temperatury podczas normalnej pracy.

Od wersji `linux-cachyos` 6.9.6 jądro jest łatane z obsługą CPB dla sterowników p-state AMD (obejmuje `passive`, `active` i `guided`).
Użytkownicy mogą zmieniać stan boost każdego rdzenia procesora za pomocą pliku boost w sysfs `/sys/devices/system/cpu/cpuX/cpufreq/boost`
(X odnosi się do numeru rdzenia, np. cpu0 to pierwszy rdzeń, cpu1 drugi itd.).

```sh
❯ echo 0 | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/boost # Wyłącz boost dla wszystkich rdzeni
❯ lscpu -ae # To pokazuje, że AMD CPB jest globalnie wyłączone
CPU NODE SOCKET CORE L1d:L1i:L2:L3 ONLINE    MAXMHZ   MINMHZ       MHZ
  0    0      0    0 0:0:0:0          yes 3301.0000 400.0000 1212.8250
  1    0      0    0 0:0:0:0          yes 3301.0000 400.0000 1394.2180
  2    0      0    1 1:1:1:0          yes 3301.0000 400.0000 1204.4600

❯ echo 1 | sudo tee /sys/devices/system/cpu/cpu0/cpufreq/boost # Włącza boost na cpu0
❯ lscpu -ae
CPU NODE SOCKET CORE L1d:L1i:L2:L3 ONLINE    MAXMHZ   MINMHZ       MHZ
  0    0      0    0 0:0:0:0          yes 4564.0000 400.0000 1393.2380
  1    0      0    0 0:0:0:0          yes 3301.0000 400.0000  400.0000
  2    0      0    1 1:1:1:0          yes 3301.0000 400.0000 2157.8469
```

CachyOS dostarcza również wersję `power-profiles-daemon`, która zawiera backport commitu włączającego
obsługę AMD CPB. AMD CPB zostanie wyłączone, jeśli używany jest profil `powersave`, i włączone w profilach `balanced` lub `performance`.

Więcej informacji znajdziesz tutaj:
- https://lore.kernel.org/linux-pm/1a78eeaa-fadd-4734-aaeb-2fe11e96e198@amd.com/T/#m4a0c8917ea8fb033504055bd61512c80c85410c8
- https://lore.kernel.org/linux-pm/20240624213400.67773-1-mario.limonciello@amd.com/

## Możliwe ulepszenia wydajności

### Wyłączanie Split Lock Mitigate

W niektórych przypadkach łagodzenie split lock może spowolnić wydajność w niektórych aplikacjach i grach. Dostępna jest łatka umożliwiająca wyłączenie tej funkcji za pomocą sysctl.

*   Wyłącz łagodzenie split lock: `sudo sysctl kernel.split_lock_mitigate=0`
*   Włącz łagodzenie split lock: `sudo sysctl kernel.split_lock_mitigate=1`

Aby zmiana była trwała, dodaj następującą linię do `/etc/sysctl.d/99-splitlock.conf`:

```text
kernel.split_lock_mitigate=0
```

Więcej informacji na temat split lock znajdziesz tutaj:

- https://www.phoronix.com/news/Linux-Splitlock-Hurts-Gaming
- https://github.com/doitsujin/dxvk/issues/2938

## Poprawki oszczędzania energii

### Włączanie RCU Lazy

RCU Lazy pomaga zmniejszyć zużycie energii w systemach bezczynnych lub lekko obciążonych. Może to być przydatne dla laptopów i urządzeń przenośnych.
Poprawa wynosi od 5 do 10% pod względem oszczędności energii. Należy jednak pamiętać, że ta funkcja oszczędzania energii może wiązać się z niewielkim spadkiem wydajności w zależności od scenariusza.
Jądro linux-cachyos-deckify będzie miało tę opcję domyślnie włączoną, ponieważ oszczędzanie energii jest kluczowe i niezbędne dla tych urządzeń.

Aby włączyć RCU Lazy, dodaj następujący parametr do listy parametrów [linii poleceń jądra](/pl/configuration/boot_manager_configuration/):
```text
rcutree.enable_rcu_lazy=1
```

## Obejścia dla NVIDIA

### Wyłączanie backendu Wayland dla SDDM

:::note
Począwszy od cachyos-kde-settings 4.3, SDDM domyślnie używa KWin jako kompozytora Wayland.
:::

Chociaż jest to krok naprzód, może wprowadzić pewne niedogodności, takie jak brak obsługi podkręcania za pomocą nvidia-settings lub powodować niekompatybilność ze starszymi procesorami graficznymi, które mają problemy z Waylandem.

Aby cofnąć tę zmianę. **Usuń** cachyos-kde-settings:
```sh
sudo pacman -R cachyos-kde-settings
```

### Firmware NVIDIA GSP

Firmware NVIDIA GSP może **"w niektórych przypadkach"** prowadzić do obniżenia wydajności. Chociaż sterownik NVIDIA 555.58.02 w dużej mierze rozwiązał ten problem, może on nadal występować w niektórych systemach.
Jeśli doświadczasz problemów z wydajnością w KDE lub niskiej wydajności w niektórych przypadkach, możesz wyłączyć firmware GSP za pomocą następującego pliku konfiguracyjnego:
`/etc/modprobe.d/nvidia-gsp.conf`

```text
options nvidia NVreg_EnableGpuFirmware=0
```

Po utworzeniu pliku wykonaj następujące polecenie:
```sh
sudo mkinitcpio -P
```

:::note
[Otwarte moduły jądra](https://github.com/NVIDIA/open-gpu-kernel-modules) NVIDIA opierają się na firmware GSP. Z tego powodu GSP nie może zostać wyłączone, a ta opcja modprobe zostanie zignorowana podczas ich używania. Użyj `linux-cachyos-nvidia` lub `nvidia-dkms`.
:::

Zazwyczaj zaleca się testowanie firmware GSP po każdej nowej instalacji sterownika NVIDIA, ponieważ często wprowadza on korzystne funkcje. Co więcej, NVIDIA rozpoczęła głównie przeprowadzanie testów QA przy użyciu firmware GSP.

## Poprawki audio

### Nadawanie uprawnień czasu rzeczywistego dla użytkownika

:::note
Może to być korzystne przy próbie rozwiązania problemów z dźwiękiem, takich jak przerwy lub zakłócenia.
:::

```sh
# Zainstaluj następujący pakiet:
sudo pacman -S realtime-privileges
# Uruchom następujące polecenie:
sudo gpasswd -a $USER realtime
# Uruchom ponownie system.
```
